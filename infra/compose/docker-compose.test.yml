services:
  postgres-test:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: tess_test
      POSTGRES_PASSWORD: tess_test_password
      POSTGRES_DB: tessdental_test
    ports:
      - "5434:5432"
    volumes:
      - tess_pg_data_test:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tess_test -d tessdental_test"]
      interval: 3s
      timeout: 3s
      retries: 30

  hasura-test:
    image: hasura/graphql-engine:v2.48.0
    restart: unless-stopped
    depends_on:
      postgres-test:
        condition: service_healthy
    ports:
      - "8082:8080"
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://tess_test:tess_test_password@postgres-test:5432/tessdental_test
      HASURA_GRAPHQL_ADMIN_SECRET: testadminsecret
      HASURA_GRAPHQL_ENABLE_CONSOLE: "false"
      HASURA_GRAPHQL_DEV_MODE: "true"
      HASURA_GRAPHQL_UNAUTHORIZED_ROLE: public
      HASURA_GRAPHQL_CORS_DOMAIN: "*"
      # These JWT values are only for local/test use
      # Key must be at least 32 characters for HS256
      HASURA_GRAPHQL_JWT_SECRET: '{"type":"HS256","key":"testjwtsecret_testjwtsecret_testjwt","issuer":"test-issuer","audience":"test-audience","claims_namespace":"https://hasura.io/jwt/claims"}'

  auth-test:
    build:
      context: ../../
      dockerfile: apps/auth/Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://tess_test:tess_test_password@postgres-test:5432/tessdental_test
      JWT_SECRET: testjwtsecret_testjwtsecret_testjwt
      JWT_ISSUER: test-issuer
      JWT_AUDIENCE: test-audience
      PORT: 4000
      NODE_ENV: test
    ports:
      - "4001:4000"
    depends_on:
      postgres-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/healthz', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s

  # MinIO for test storage backend
  minio-test:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: testminio
      MINIO_ROOT_PASSWORD: testminiopassword
    ports:
      - "9010:9000"
      - "9011:9001"
    volumes:
      - tess_minio_data_test:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 3s
      retries: 30

  # Initialize MinIO bucket for tests
  minio-init-test:
    image: minio/mc:latest
    depends_on:
      minio-test:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: testminio
      MINIO_ROOT_PASSWORD: testminiopassword
      MINIO_BUCKET: tess-imaging-test
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      mc alias set local http://minio-test:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD &&
      mc mb -p local/$$MINIO_BUCKET || true &&
      mc anonymous set none local/$$MINIO_BUCKET || true
      "
    restart: "no"

  # Imaging service for test environment
  imaging-service-test:
    build:
      context: ../../
      dockerfile: apps/imaging-service/Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: test
      PORT: 4010

      # Database
      DATABASE_URL: postgres://tess_test:tess_test_password@postgres-test:5432/tessdental_test

      # JWT verification
      JWT_SECRET: testjwtsecret_testjwtsecret_testjwt
      JWT_ISSUER: test-issuer
      JWT_AUDIENCE: test-audience

      # Auth / Hasura integration
      HASURA_GRAPHQL_URL: http://hasura-test:8080/v1/graphql
      HASURA_GRAPHQL_ADMIN_SECRET: testadminsecret

      # Storage backend
      IMAGING_STORAGE_BACKEND: s3

      # S3/MinIO settings
      IMAGING_S3_ENDPOINT: http://minio-test:9000
      IMAGING_S3_REGION: us-east-1
      IMAGING_S3_BUCKET: tess-imaging-test
      IMAGING_S3_ACCESS_KEY_ID: testminio
      IMAGING_S3_SECRET_ACCESS_KEY: testminiopassword
      IMAGING_S3_FORCE_PATH_STYLE: "true"

      # Operational
      IMAGING_MAX_UPLOAD_MB: 100
      IMAGING_THUMBS_ENABLED: "true"
    ports:
      - "4011:4010"
    depends_on:
      minio-test:
        condition: service_healthy
      postgres-test:
        condition: service_healthy
      hasura-test:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4010/health"]
      interval: 5s
      timeout: 3s
      retries: 30

volumes:
  tess_pg_data_test:
  tess_minio_data_test:

